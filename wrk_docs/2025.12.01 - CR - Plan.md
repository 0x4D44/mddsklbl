# Code Review Plan - Desktop Labeler (mddsklbl)

**Date:** 2025-12-01
**Reviewer:** Claude Code
**Project:** mddskmgr (binary: mddsklbl) v1.0.11
**Language:** Rust (Edition 2024)

---

## 1. Code Inventory

### Source Files (src/)
| File | Lines | Purpose |
|------|-------|---------|
| `main.rs` | 34 | Entry point, logging setup, platform gates |
| `lib.rs` | 16 | Module exports |
| `windows_main.rs` | 789 | Win32 window, message loop, app state management |
| `config.rs` | 186 | Configuration schema, JSON serialization, atomic save |
| `core.rs` | 37 | Pure visibility logic |
| `hotkeys.rs` | 86 | Global hotkey registration/unregistration |
| `overlay.rs` | 560 | Layered window rendering (Direct2D/GDI) |
| `tray.rs` | 214 | System tray icon and context menu |
| `ui.rs` | 411 | Modal input dialog |
| `vd.rs` | 57 | Virtual desktop detection (events/polling) |
| `autorun.rs` | 210 | Registry-based Run at Login |
| `utils.rs` | 5 | UTF-16 conversion utility |

### Build Files
| File | Purpose |
|------|---------|
| `build.rs` | Icon generation, Windows resource embedding, manifest |
| `Cargo.toml` | Dependencies and build configuration |

### Test Files (tests/)
| File | Purpose |
|------|---------|
| `config_roundtrip.rs` | Config save/load cycle test |
| `hotkeys.rs` | Virtual key mapping tests |
| `hotkey_duplicates.rs` | Duplicate hotkey detection tests |
| `visibility.rs` | Visibility truth table tests |

---

## 2. Review Categories

### 2.1 Architecture & Design
- [ ] Module organization and separation of concerns
- [ ] Data flow between components
- [ ] Platform abstraction (`#[cfg(windows)]` usage)
- [ ] Thread safety and concurrency model
- [ ] State management pattern (thread_local `RefCell`)

### 2.2 Code Quality & Best Practices
- [ ] Rust idioms and conventions
- [ ] Naming consistency
- [ ] Documentation coverage
- [ ] Dead code / unused imports
- [ ] Clippy compliance
- [ ] Code duplication

### 2.3 Error Handling & Safety
- [ ] `unsafe` block justification and correctness
- [ ] Result/Option propagation
- [ ] Panic-safety
- [ ] Resource cleanup (RAII patterns)
- [ ] Windows API error handling

### 2.4 Performance
- [ ] Memory allocations in hot paths
- [ ] Timer/polling efficiency
- [ ] Rendering pipeline efficiency
- [ ] Unnecessary cloning

### 2.5 Security
- [ ] Input validation
- [ ] Registry access patterns
- [ ] File system operations (path traversal, permissions)
- [ ] Shell command injection risks
- [ ] Memory safety in FFI boundaries

### 2.6 Reliability
- [ ] Edge case handling
- [ ] Graceful degradation
- [ ] Single-instance enforcement
- [ ] Session lock/unlock behavior

### 2.7 Windows API Usage
- [ ] Correct Win32 API patterns
- [ ] Handle/resource leaks
- [ ] Message loop correctness
- [ ] DPI awareness implementation

---

## 3. Review Execution Plan

### Phase 1: Static Analysis
1. Analyze module dependencies and coupling
2. Review public API surface
3. Identify unsafe code blocks and audit each

### Phase 2: Component Deep Dive
1. **Config subsystem** - JSON handling, migration logic, atomic saves
2. **Overlay rendering** - Direct2D/GDI paths, resource management
3. **Window management** - Message handling, re-entrancy safety
4. **Hotkey system** - Registration, conflict detection
5. **Virtual desktop detection** - Event/polling hybrid
6. **Tray icon** - Shell integration, menu handling
7. **Autorun** - Registry manipulation safety

### Phase 3: Cross-Cutting Concerns
1. Thread safety audit
2. Error propagation consistency
3. Resource lifecycle verification

### Phase 4: Test Coverage Assessment
1. Unit test quality
2. Integration test gaps
3. Edge case coverage

---

## 4. Key Focus Areas

Based on initial review, these areas warrant extra scrutiny:

1. **RefCell re-entrancy in wndproc** - Complex borrowing patterns with Windows callbacks
2. **Unsafe FFI in overlay.rs** - Raw pointer manipulation for DIB sections
3. **Thread-local state** - `APP` global and cross-thread message passing
4. **HWND pointer casting** - `as usize` for thread spawning
5. **Registry operations** - Proper cleanup on all paths

---

## 5. Deliverables

1. **This Plan** - `2025.12.01 - CR - Plan.md`
2. **Comprehensive Report** - `2025.12.01 - CR - Comprehensive Report.md`
   - Executive Summary
   - Findings by Category (Critical/High/Medium/Low/Info)
   - Positive Observations
   - Recommendations
